# NYRO æ¶æ„å‡çº§éœ€æ±‚æ–‡æ¡£

> ç‰ˆæœ¬: v2.0  
> æ—¥æœŸ: 2026-01-30  
> çŠ¶æ€: **å¼€å‘ä¸­** (DB Less æ¨¡å¼å¼€å‘ä¸­)

---

## ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [å®æ–½è¿›åº¦](#å®æ–½è¿›åº¦)
3. [èµ„æºæ¨¡å‹è®¾è®¡](#èµ„æºæ¨¡å‹è®¾è®¡)
4. [éœ€æ±‚ä¸€ï¼šé‡æ„è·¯ç”±å¼•æ“](#éœ€æ±‚ä¸€é‡æ„è·¯ç”±å¼•æ“)
5. [éœ€æ±‚äºŒï¼šç§»é™¤ Consul ä¾èµ–](#éœ€æ±‚äºŒç§»é™¤-consul-ä¾èµ–)
6. [éœ€æ±‚ä¸‰ï¼šAI Proxy èƒ½åŠ›](#éœ€æ±‚ä¸‰ai-proxy-èƒ½åŠ›)
7. [æŠ€æœ¯è·¯çº¿å›¾](#æŠ€æœ¯è·¯çº¿å›¾)
8. [é…ç½®æ–‡ä»¶è®¾è®¡](#é…ç½®æ–‡ä»¶è®¾è®¡)

---

## æ¦‚è¿°

æœ¬æ¬¡æ¶æ„å‡çº§æ—¨åœ¨æå‡ NYRO çš„æ€§èƒ½ã€ç®€åŒ–éƒ¨ç½²å¤æ‚åº¦ã€å¹¶å¢åŠ å¯¹ AI åœºæ™¯çš„æ”¯æŒã€‚ä¸»è¦åŒ…å«ä¸‰å¤§æ ¸å¿ƒæ”¹åŠ¨ï¼š

| åºå· | éœ€æ±‚ | ç›®æ ‡ |
|------|------|------|
| 1 | é‡æ„è·¯ç”±å¼•æ“ | ä½¿ç”¨ Radix Tree å®ç°é«˜æ€§èƒ½è·¯ç”±ï¼Œæ”¯æŒå¤šç§åŒ¹é…æ¨¡å¼ |
| 2 | ç§»é™¤ Consul ä¾èµ– | å®ç° DB Less / Hybrid æ¨¡å¼ï¼Œé™ä½éƒ¨ç½²å¤æ‚åº¦ |
| 3 | AI Proxy èƒ½åŠ› | æ”¯æŒ LLM åè®®æ ‡å‡†åŒ–ã€å¤š Key ç®¡ç†ã€æ•…éšœè½¬ç§» |

### å¼€å‘é˜¶æ®µè§„åˆ’

| é˜¶æ®µ | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| **Phase 1: DB Less** | å£°æ˜å¼é…ç½®ã€æ–°èµ„æºæ¨¡å‹ã€è·¯ç”±å¼•æ“ | ğŸš§ å¼€å‘ä¸­ |
| **Phase 2: Hybrid** | CP/DP åˆ†ç¦»ã€MongoDB é›†æˆ | â³ å¾…å¼€å‘ |
| **Phase 3: AI Proxy** | LLM åè®®æ ‡å‡†åŒ–ã€å¤š Key ç®¡ç† | â³ å¾…å¼€å‘ |

---

## å®æ–½è¿›åº¦

### Phase 1: DB Less æ¨¡å¼

| æ­¥éª¤ | çŠ¶æ€ | å®Œæˆæ—¥æœŸ |
|------|------|----------|
| Step 1: FFI è·¯ç”±å¼•æ“ (Rax + Khash) | âœ… å·²å®Œæˆ | 2026-01-30 |
| Step 2: Store æŠ½è±¡å±‚ | âœ… å·²å®Œæˆ | 2026-01-30 |
| Step 3: ç³»ç»Ÿé›†æˆ (Router + Balancer) | âœ… å·²å®Œæˆ | 2026-01-30 |
| Step 4: Consul ç§»é™¤ä¸æ¸…ç† | âœ… å·²å®Œæˆ | 2026-01-30 |
| Step 5: æ­£åˆ™åŒ¹é…æ”¯æŒ | âœ… å·²å®Œæˆ | 2026-01-30 |
| Step 6: æ–°èµ„æºæ¨¡å‹å®ç° | ğŸš§ å¼€å‘ä¸­ | - |

### å·²å®Œæˆå·¥ä½œè¯¦æƒ…

#### 1. FFI è·¯ç”±å¼•æ“ (Rax + Khash)

é€‰æ‹©äº† **æ–¹æ¡ˆ B: è‡ªè¡Œå°è£… Rax FFI**ï¼Œå®ç°äº†åŸºäº C çš„é«˜æ€§èƒ½è·¯ç”±å¼•æ“ã€‚

**æ–°å¢æ–‡ä»¶:**

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `deps/nyro/nyro_router.h` | C å¤´æ–‡ä»¶ï¼Œå®šä¹‰è·¯ç”±å¼•æ“æ¥å£ |
| `deps/nyro/nyro_router.c` | C å®ç°ï¼ŒåŸºäº Rax (Radix Tree) + Khash |
| `deps/nyro/Makefile` | C åº“ç¼–è¯‘è„šæœ¬ |
| `deps/rax/rax.h` | Rax åº“å¤´æ–‡ä»¶ |
| `deps/rax/rax.c` | Rax åº“å®ç° |
| `nyro/sys/router/ffi.lua` | LuaJIT FFI ç»‘å®šå®šä¹‰ |
| `nyro/sys/router/matcher.lua` | Lua å°è£…å±‚ï¼Œæä¾›é¢å‘å¯¹è±¡ API |
| `nyro/sys/router/init.lua` | è·¯ç”±æ¨¡å—å…¥å£ |

**æ”¯æŒçš„åŒ¹é…ç±»å‹:**

| ç±»å‹ | ç¤ºä¾‹ | è‡ªåŠ¨æ¨å¯¼è§„åˆ™ | çŠ¶æ€ |
|------|------|-------------|------|
| ç²¾ç¡®åŒ¹é… | `/api/v1/users` | é»˜è®¤ | âœ… å·²å®ç° |
| å‚æ•°åŒ¹é… | `/api/v1/users/{id}` | åŒ…å« `{param}` | âœ… å·²å®ç° |
| å‰ç¼€åŒ¹é… | `/api/v1/articles/*` | ä»¥ `/*` ç»“å°¾ | âœ… å·²å®ç° |
| æ­£åˆ™åŒ¹é… | `~^/api/v[0-9]+/.*` | ä»¥ `~` å¼€å¤´ | âœ… å·²å®ç° |

#### 2. Store æŠ½è±¡å±‚ (DB Less æ¨¡å¼)

å®ç°äº†å­˜å‚¨æŠ½è±¡å±‚ï¼Œæ”¯æŒä» YAML æ–‡ä»¶å£°æ˜å¼åŠ è½½é…ç½®ã€‚

**æ–°å¢æ–‡ä»¶:**

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `nyro/store/init.lua` | Store æŠ½è±¡å±‚å…¥å£ |
| `nyro/store/adapter/yaml.lua` | YAML é€‚é…å™¨ (DB Less æ¨¡å¼) |
| `conf/config.yaml` | å£°æ˜å¼é…ç½®æ–‡ä»¶ |

#### 3. ç³»ç»Ÿé›†æˆ

å°†æ–°çš„è·¯ç”±å¼•æ“å’Œ Store å±‚é›†æˆåˆ°ç³»ç»Ÿå¯åŠ¨æµç¨‹ã€‚

**ä¿®æ”¹æ–‡ä»¶:**

| æ–‡ä»¶ | æ”¹åŠ¨å†…å®¹ |
|------|---------|
| `nyro/sys/router.lua` | å®Œå…¨é‡å†™ï¼Œä½¿ç”¨ FFI è·¯ç”±å¼•æ“ + Store |
| `nyro/sys/balancer.lua` | é‡å†™ï¼Œä½¿ç”¨ Store è·å– upstream æ•°æ® |
| `nyro/sys/dao.lua` | é‡å†™ï¼Œä½¿ç”¨ Store åˆå§‹åŒ– |
| `nyro/sys/admin.lua` | é‡å†™ï¼Œstandalone æ¨¡å¼ä¸‹ç¦ç”¨ Admin API |
| `nyro/cmd/env.lua` | ç§»é™¤ Consul æ£€æŸ¥ï¼Œæ·»åŠ  Store é…ç½®éªŒè¯ |

#### 4. Consul ç§»é™¤

å½»åº•ç§»é™¤ Consul ä¾èµ–ï¼Œä¿ç•™å‘åå…¼å®¹çš„å­˜æ ¹æ¨¡å—ã€‚

---

## èµ„æºæ¨¡å‹è®¾è®¡

### èµ„æºå±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¯·æ±‚å…¥å£                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  routes (è·¯ç”±)                                               â”‚
â”‚  â”œâ”€â”€ paths, methods, hosts, headers (åŒ¹é…æ¡ä»¶)              â”‚
â”‚  â”œâ”€â”€ priority, strip_path, preserve_host                    â”‚
â”‚  â”œâ”€â”€ plugins (è·¯ç”±çº§æ’ä»¶)                                    â”‚
â”‚  â””â”€â”€ service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” (å¿…é¡»å¼•ç”¨)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  services (æœåŠ¡) - upstream çš„é€»è¾‘æŠ½è±¡                       â”‚
â”‚  â”œâ”€â”€ protocol, path                                         â”‚
â”‚  â”œâ”€â”€ plugins (æœåŠ¡çº§æ’ä»¶)                                    â”‚
â”‚  â””â”€â”€ backend â”€â”€â”€â”€â”€â”€â”  æˆ–  url (ç›´æ¥ä»£ç†)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  backends (åç«¯) - å¯¹åº” Nginx upstream                       â”‚
â”‚  â”œâ”€â”€ endpoints (ç«¯ç‚¹åˆ—è¡¨)                                    â”‚
â”‚  â”œâ”€â”€ algorithm (è´Ÿè½½å‡è¡¡ç®—æ³•)                                â”‚
â”‚  â”œâ”€â”€ timeout, retries                                       â”‚
â”‚  â””â”€â”€ health_check                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  plugins (å…¨å±€)      â”‚    â”‚  consumers          â”‚
â”‚  å¯¹æ‰€æœ‰è¯·æ±‚ç”Ÿæ•ˆ       â”‚    â”‚  è®¤è¯ä¸»ä½“ + å‡­è¯     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  certificates       â”‚
â”‚  SSL/TLS è¯ä¹¦       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒè§„åˆ™

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| route å¿…é¡»å¼•ç”¨ service | route ä¸ç›´æ¥ä¸ backend å…³è” |
| service æ˜¯ upstream çš„é€»è¾‘æŠ½è±¡ | å¯å¼•ç”¨ backend æˆ–ç›´æ¥ä½¿ç”¨ url |
| é…ç½®å­˜åœ¨å³åŠ è½½ | æ—  enabled å­—æ®µï¼Œé…ç½®å³ç”Ÿæ•ˆ |
| æ’ä»¶ä½¿ç”¨ name æŒ‡å®š | å…¨å±€å’Œå†…è”æ’ä»¶ç»Ÿä¸€ä½¿ç”¨ name å­—æ®µ |

### èµ„æºå®šä¹‰

#### 1. plugins (å…¨å±€æ’ä»¶)

å¯¹æ‰€æœ‰è¯·æ±‚ç”Ÿæ•ˆçš„æ’ä»¶é…ç½®ã€‚

```yaml
plugins:
  - name: cors
    config:
      allow_origins: "*"
      allow_methods: ["GET", "POST", "PUT", "DELETE"]
  
  - name: request-id
    config:
      header_name: X-Request-ID
```

#### 2. backends (åç«¯)

å¯¹åº” Nginx upstreamï¼Œå®šä¹‰åç«¯æœåŠ¡é›†ç¾¤ã€‚

```yaml
backends:
  - name: user-backend
    algorithm: roundrobin              # roundrobin | chash | least_conn
    endpoints:                         # ç«¯ç‚¹åˆ—è¡¨
      - address: 192.168.1.10:9001
        weight: 100
      - address: 192.168.1.11:9002
        weight: 100
    timeout:
      connect: 5000                    # è¿æ¥è¶…æ—¶ (ms)
      send: 60000                      # å‘é€è¶…æ—¶ (ms)
      read: 60000                      # è¯»å–è¶…æ—¶ (ms)
    retries: 3                         # é‡è¯•æ¬¡æ•°
    health_check:
      type: http                       # http | tcp | https
      path: /health
      interval: 5                      # æ£€æŸ¥é—´éš” (s)
      timeout: 2                       # æ£€æŸ¥è¶…æ—¶ (s)
      healthy:
        successes: 2
        http_statuses: [200, 302]
      unhealthy:
        failures: 3
        http_statuses: [500, 502, 503]
```

#### 3. services (æœåŠ¡)

upstream çš„é€»è¾‘æŠ½è±¡ï¼Œå¯å¼•ç”¨ backend æˆ–ç›´æ¥ä»£ç† URLã€‚

```yaml
services:
  # æ–¹å¼1: å¼•ç”¨ backend
  - name: user-service
    backend: user-backend
    protocol: http                     # http | https | grpc | grpcs
    path: /user-center                 # ä¸Šæ¸¸è·¯å¾„å‰ç¼€ (å¯é€‰)
    plugins:
      - name: request-id

  # æ–¹å¼2: ç›´æ¥ä»£ç† URL
  - name: external-api
    url: https://api.external.com
    protocol: https
```

#### 4. routes (è·¯ç”±)

è¯·æ±‚åŒ¹é…è§„åˆ™ï¼Œå¿…é¡»å¼•ç”¨ä¸€ä¸ª serviceã€‚

```yaml
routes:
  - name: user-login
    service: user-service              # å¿…é¡»å¼•ç”¨ service
    hosts:
      - api.example.com
    paths:
      - /api/v1/login
    methods: [POST]
    priority: 100                      # è·¯ç”±ä¼˜å…ˆçº§
    strip_path: false                  # æ˜¯å¦å‰¥ç¦»åŒ¹é…è·¯å¾„
    preserve_host: true                # æ˜¯å¦ä¿ç•™åŸå§‹ Host
    plugins:
      - name: jwt-auth
      - name: rate-limiting
        config:
          rate: 100
          burst: 50
```

**è·¯ç”±åŒ¹é…ç±»å‹:**

| ç±»å‹ | è·¯å¾„ç¤ºä¾‹ | è‡ªåŠ¨æ¨å¯¼è§„åˆ™ |
|------|---------|-------------|
| ç²¾ç¡®åŒ¹é… | `/api/v1/users` | é»˜è®¤ |
| å‰ç¼€åŒ¹é… | `/api/v1/articles/*` | ä»¥ `/*` ç»“å°¾ |
| å‚æ•°åŒ¹é… | `/api/v1/users/{id}` | åŒ…å« `{param}` |
| æ­£åˆ™åŒ¹é… | `~^/api/v[0-9]+/.*` | ä»¥ `~` å¼€å¤´ |

#### 5. consumers (æ¶ˆè´¹è€…)

API æ¶ˆè´¹è€…ï¼Œç”¨äºè®¤è¯å’Œé™æµã€‚

```yaml
consumers:
  - name: mobile-app
    credentials:
      key-auth:
        key: mobile-app-api-key
      jwt-auth:
        key: mobile-app
        secret: jwt-secret
    plugins:
      - name: rate-limiting
        config:
          rate: 1000
          burst: 100
```

#### 6. certificates (è¯ä¹¦)

SSL/TLS è¯ä¹¦é…ç½®ã€‚

```yaml
certificates:
  - name: example-cert
    snis:
      - "*.example.com"
      - "example.com"
    cert: |
      -----BEGIN CERTIFICATE-----
      ...
      -----END CERTIFICATE-----
    key: |
      -----BEGIN PRIVATE KEY-----
      ...
      -----END PRIVATE KEY-----
```

### æœ€å°é…ç½®å•å…ƒ

#### åœºæ™¯ 1: ä»£ç†åˆ°å†…éƒ¨åç«¯

```yaml
backends:
  - name: api-backend
    endpoints:
      - address: 127.0.0.1:8080

services:
  - name: api-service
    backend: api-backend

routes:
  - name: api
    service: api-service
    paths:
      - /api/*
```

#### åœºæ™¯ 2: ä»£ç†åˆ°å¤–éƒ¨ URL

```yaml
services:
  - name: external-service
    url: https://api.external.com

routes:
  - name: external
    service: external-service
    paths:
      - /external/*
```

#### åœºæ™¯ 3: å¸¦è®¤è¯çš„ API

```yaml
backends:
  - name: api-backend
    endpoints:
      - address: 127.0.0.1:8080

services:
  - name: api-service
    backend: api-backend

routes:
  - name: api
    service: api-service
    paths:
      - /api/*
    plugins:
      - name: key-auth

consumers:
  - name: my-app
    credentials:
      key-auth:
        key: my-api-key
```

---

## éœ€æ±‚ä¸€ï¼šé‡æ„è·¯ç”±å¼•æ“

### èƒŒæ™¯

å½“å‰ä½¿ç”¨çš„ `lua-resty-oakrouting` æ˜¯çº¯ Lua å®ç°ï¼Œåœ¨å¤§é‡è·¯ç”±åœºæ™¯ä¸‹æ€§èƒ½æœ‰é™ã€‚éœ€è¦å‡çº§ä¸ºåŸºäº Radix Tree çš„é«˜æ€§èƒ½è·¯ç”±å¼•æ“ã€‚

### ç›®æ ‡

åŸºäº **Rax (Radix Tree)** å®ç°é«˜æ€§èƒ½è·¯ç”±å¼•æ“ï¼Œæ”¯æŒå››ç§åŒ¹é…æ¨¡å¼ã€‚

### æŠ€æœ¯é€‰å‹

#### æ–¹æ¡ˆ B: è‡ªè¡Œå°è£… Rax FFI âœ… **å·²é€‰æ‹©**

- **ä¼˜ç‚¹**: è½»é‡åŒ–ï¼Œå¯é’ˆå¯¹ NYRO é…ç½®ç»“æ„ä¼˜åŒ–
- **çŠ¶æ€**: **å·²å®ç°** - åŸºäº Rax + Khash å®ç°é«˜æ€§èƒ½è·¯ç”±å¼•æ“

### å®ç°æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Lua Layer (LuaJIT)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  nyro/sys/router/init.lua     (æ¨¡å—å…¥å£)          â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  nyro/sys/router/matcher.lua  (é¢å‘å¯¹è±¡å°è£…)      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  nyro/sys/router/ffi.lua      (FFI å®šä¹‰)          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                â”‚
â”‚                       FFI è°ƒç”¨                              â”‚
â”‚                            â–¼                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     C Layer (libnyro_router)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   Rax (Radix Tree) â”‚    â”‚  Khash (Hash Table)â”‚            â”‚
â”‚  â”‚   - è·¯å¾„ç´¢å¼•       â”‚    â”‚  - Host ç´¢å¼•      â”‚            â”‚
â”‚  â”‚   - å‰ç¼€åŒ¹é…       â”‚    â”‚  - å¿«é€ŸæŸ¥æ‰¾       â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼˜å…ˆçº§ä»²è£è§„åˆ™

å½“å¤šæ¡è·¯ç”±å¯èƒ½åŒ¹é…åŒä¸€è¯·æ±‚æ—¶ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºå†³å®šï¼š

1. **ç²¾ç¡®åŒ¹é…** (ä¼˜å…ˆçº§æœ€é«˜)
2. **å‚æ•°åŒ¹é…**
3. **å‰ç¼€åŒ¹é…** (æœ€é•¿å‰ç¼€ä¼˜å…ˆ)
4. **æ­£åˆ™åŒ¹é…** (æŒ‰ priority æ’åº)

---

## éœ€æ±‚äºŒï¼šç§»é™¤ Consul ä¾èµ–

### èƒŒæ™¯

ç§»é™¤ Consul ä¾èµ–ï¼Œè½¬å‘ **DB Less (å£°æ˜å¼)** å’Œ **Hybrid (æ§åˆ¶é¢/æ•°æ®é¢åˆ†ç¦»)** æ¨¡å¼ï¼Œæ˜¯äº‘åŸç”Ÿç½‘å…³çš„ä¸»æµæ¼”è¿›æ–¹å‘ã€‚

### å¼€å‘ç­–ç•¥

| é˜¶æ®µ | æ¨¡å¼ | çŠ¶æ€ |
|------|------|------|
| Phase 1 | DB Less (Standalone) | ğŸš§ å¼€å‘ä¸­ |
| Phase 2 | Hybrid (CP/DP + MongoDB) | â³ å¾… Phase 1 ç¨³å®šåå¼€å‘ |

### æ¨¡å¼ä¸€ï¼šDB Less (Standalone) - å½“å‰é˜¶æ®µ

#### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   NYRO Node                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚config.yamlâ”‚â”€â”€â”€â–¶â”‚  ngx.shared.DICT (å†…å­˜)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        â”‚                      â”‚                 â”‚
â”‚   HUP Signal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ çƒ­åŠ è½½              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒé€»è¾‘

1. **é…ç½®è½½ä½“**: å£°æ˜å¼ `config.yaml` é…ç½®æ–‡ä»¶
2. **å¯åŠ¨åŠ è½½**: åœ¨ `init_by_lua` é˜¶æ®µè§£æ YAML â†’ æ ¡éªŒ â†’ å†™å…¥å†…å­˜
3. **çƒ­æ›´æ–°**: å‘é€ HUP ä¿¡å·è§¦å‘é‡æ–°åŠ è½½

#### é€‚ç”¨åœºæ™¯

- K8s Ingress / Gateway API
- Ansible/SaltStack ç®¡ç†
- GitOps å·¥ä½œæµ

### æ¨¡å¼äºŒï¼šHybrid (CP/DP åˆ†ç¦») - å¾…å¼€å‘

> â³ å¾… DB Less æ¨¡å¼ç¨³å®šåå¼€å‘

#### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Control Plane  â”‚        â”‚        Data Plane           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Admin API â”‚  â”‚        â”‚  â”‚   ngx.shared.DICT     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚        â”‚        â”‚              â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€HTTP Long Pollingâ”€â”€â”€â”€â”€â”€â”‚
â”‚  â”‚  MongoDB  â”‚  â”‚        â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                 â”‚        â”‚  â”‚  Local Config Dump    â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”˜
```

---

## éœ€æ±‚ä¸‰ï¼šAI Proxy èƒ½åŠ›

> â³ å¾… DB Less æ¨¡å¼ç¨³å®šåå¼€å‘

### èƒŒæ™¯

AI Proxy æ˜¯ç›®å‰ API ç½‘å…³æœ€ç«çƒ­çš„åœºæ™¯ï¼Œæœ¬è´¨æ˜¯ä¸ƒå±‚æµé‡æ²»ç†åœ¨ LLM åœºæ™¯ä¸‹çš„ç‰¹åŒ–ã€‚

### ç›®æ ‡

æä¾›æ ‡å‡†åŒ–çš„ AI æ¥å£ä¸æ²»ç†èƒ½åŠ›ï¼Œè®©ç”¨æˆ·å¯ä»¥ç”¨ä»»æ„ OpenAI å…¼å®¹å®¢æˆ·ç«¯æ— ç¼è¿æ¥å„ç§ LLM Providerã€‚

### Phase 1: åè®®æ ‡å‡†åŒ– (The Unifier)

| åŠŸèƒ½ | æè¿° |
|------|------|
| å¯¹å¤–æ¥å£ | ç»Ÿä¸€æš´éœ² OpenAI å…¼å®¹æ¥å£ (`/v1/chat/completions`) |
| è¯·æ±‚è½¬æ¢ | å°†è¯·æ±‚é€‚é…ä¸ºå„å‚å•†æ ¼å¼ (Anthropic, Google, DeepSeek ç­‰) |
| æµå¼å¤„ç† | ç»Ÿä¸€ SSE (Server-Sent Events) å“åº”æ ¼å¼ |

### Phase 2: ç®—åŠ›è°ƒåº¦ä¸é«˜å¯ç”¨

| åŠŸèƒ½ | æè¿° |
|------|------|
| å¤š Key è½®è¯¢ | é…ç½®å¤šä¸ª API Keyï¼Œæ”¯æŒ Round-Robin æˆ–åŠ æƒè½®è¯¢ |
| æ™ºèƒ½é‡è¯• | é’ˆå¯¹ 429 / 503 è‡ªåŠ¨é‡è¯• |
| æ•…éšœè½¬ç§» | Provider çº§åˆ« Fallback |

---

## æŠ€æœ¯è·¯çº¿å›¾

### æ‰§è¡Œé¡ºåº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 1: DB Less æ¨¡å¼                            ğŸš§ å¼€å‘ä¸­    â”‚
â”‚  â”œâ”€â”€ âœ… FFI è·¯ç”±å¼•æ“ (Rax + Khash)                             â”‚
â”‚  â”œâ”€â”€ âœ… Store æŠ½è±¡å±‚ (YAML é€‚é…å™¨)                             â”‚
â”‚  â”œâ”€â”€ âœ… ç³»ç»Ÿé›†æˆ (Router + Balancer)                          â”‚
â”‚  â”œâ”€â”€ âœ… Consul ç§»é™¤ä¸æ¸…ç†                                      â”‚
â”‚  â”œâ”€â”€ âœ… å››ç§è·¯ç”±åŒ¹é…æ¨¡å¼                                       â”‚
â”‚  â””â”€â”€ ğŸš§ æ–°èµ„æºæ¨¡å‹å®ç°                                         â”‚
â”‚       â”œâ”€â”€ â³ backends èµ„æºæ”¯æŒ                                 â”‚
â”‚       â”œâ”€â”€ â³ services èµ„æºæ”¯æŒ                                 â”‚
â”‚       â”œâ”€â”€ â³ routes èµ„æºæ”¯æŒ                                   â”‚
â”‚       â”œâ”€â”€ â³ consumers èµ„æºæ”¯æŒ                                â”‚
â”‚       â”œâ”€â”€ â³ certificates èµ„æºæ”¯æŒ                             â”‚
â”‚       â””â”€â”€ â³ plugins èµ„æºæ”¯æŒ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Phase 2: Hybrid æ¨¡å¼                             â³ å¾…å¼€å‘    â”‚
â”‚  â”œâ”€â”€ â³ é›†æˆ lua-resty-mongol                                  â”‚
â”‚  â”œâ”€â”€ â³ å®ç° CP Admin API (CRUD â†’ MongoDB)                     â”‚
â”‚  â”œâ”€â”€ â³ å®ç° DP HTTP Long Polling åŒæ­¥                         â”‚
â”‚  â””â”€â”€ â³ æœ¬åœ° Config Dump å®¹ç¾                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Phase 3: AI Proxy æ’ä»¶                           â³ å¾…å¼€å‘    â”‚
â”‚  â”œâ”€â”€ â³ åè®®æ ‡å‡†åŒ– + SSE æµå¼å¤„ç†                              â”‚
â”‚  â”œâ”€â”€ â³ å¤š Key ç®¡ç† + æ•…éšœè½¬ç§»                                 â”‚
â”‚  â””â”€â”€ â³ Token ä¼°ç®— + ç¼“å­˜ (å¯é€‰)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¾èµ–å…³ç³»

```
Phase 1 (DB Less) ğŸš§ â”€â”€â–¶ Phase 2 (Hybrid) â³
                   â”‚
                   â””â”€â”€â–¶ Phase 3 (AI Proxy) â³
```

---

## é…ç½®æ–‡ä»¶è®¾è®¡

### nyro.yaml (ç³»ç»Ÿé…ç½®)

```yaml
# NYRO ç³»ç»Ÿé…ç½®æ–‡ä»¶

# è¿è¡Œæ¨¡å¼: standalone (DB Less) | hybrid (CP/DP åˆ†ç¦»)
mode: standalone

# ============================================================
# Standalone æ¨¡å¼é…ç½® (DB Less)
# ============================================================
standalone:
  config_file: conf/config.yaml
  reload_method: signal

# ============================================================
# Hybrid æ¨¡å¼é…ç½® (å¾…å¼€å‘)
# ============================================================
# hybrid:
#   role: dp
#   control_plane:
#     listen:
#       host: 0.0.0.0
#       port: 9080
#     mongodb:
#       uri: mongodb://localhost:27017
#       database: nyro
#   data_plane:
#     control_plane_endpoints:
#       - http://cp-1.nyro.local:9080

# ============================================================
# æ’ä»¶é…ç½®
# ============================================================
plugins:
  - cors
  - key-auth
  - jwt-auth
  - basic-auth
  - limit-req
  - limit-conn
  - limit-count
  - ip-restriction
  - request-id

# ============================================================
# æ—¥å¿—é…ç½®
# ============================================================
logging:
  level: info
  path: logs/

# ============================================================
# æ€§èƒ½é…ç½®
# ============================================================
performance:
  worker_processes: auto
  shared_dict_size: 64m
```

### config.yaml (å£°æ˜å¼é…ç½®)

```yaml
#
# NYRO å£°æ˜å¼é…ç½®æ–‡ä»¶ (DB Less æ¨¡å¼)
#

version: "1.0"

# ============================================================
# å…¨å±€æ’ä»¶
# ============================================================
plugins:
  - name: cors
    config:
      allow_origins: "*"
      allow_methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]

  - name: request-id
    config:
      header_name: X-Request-ID
      include_in_response: true

# ============================================================
# åç«¯å®šä¹‰
# ============================================================
backends:
  - name: user-backend
    algorithm: roundrobin
    endpoints:
      - address: 192.168.1.10:9001
        weight: 100
      - address: 192.168.1.11:9002
        weight: 100
    timeout:
      connect: 5000
      send: 60000
      read: 60000
    retries: 3
    health_check:
      type: http
      path: /health
      interval: 5
      timeout: 2
      healthy:
        successes: 2
        http_statuses: [200, 302]
      unhealthy:
        failures: 3
        http_statuses: [500, 502, 503]

# ============================================================
# æœåŠ¡å®šä¹‰
# ============================================================
services:
  - name: user-service
    backend: user-backend
    protocol: http
    path: /user-center
    plugins:
      - name: request-id

  - name: external-api
    url: https://api.external.com
    protocol: https

# ============================================================
# è·¯ç”±å®šä¹‰
# ============================================================
routes:
  # ç²¾ç¡®åŒ¹é…
  - name: user-login
    service: user-service
    hosts:
      - api.example.com
    paths:
      - /api/v1/login
    methods: [POST]
    priority: 100

  # å‚æ•°åŒ¹é…
  - name: user-profile
    service: user-service
    paths:
      - /api/v1/users/{id}
    methods: [GET, PUT, DELETE]
    priority: 90
    plugins:
      - name: jwt-auth

  # å‰ç¼€åŒ¹é…
  - name: order-api
    service: user-service
    paths:
      - /api/v1/orders/*
    methods: [GET, POST, PUT, DELETE]
    priority: 80

  # æ­£åˆ™åŒ¹é…
  - name: legacy-api
    service: external-api
    paths:
      - ~^/legacy/v[0-9]+/.*
    methods: [GET]
    priority: 10

# ============================================================
# æ¶ˆè´¹è€…å®šä¹‰
# ============================================================
consumers:
  - name: mobile-app
    credentials:
      key-auth:
        key: mobile-app-api-key
      jwt-auth:
        key: mobile-app
        secret: jwt-secret
    plugins:
      - name: rate-limiting
        config:
          rate: 1000
          burst: 100

# ============================================================
# SSL è¯ä¹¦å®šä¹‰
# ============================================================
certificates:
  - name: example-cert
    snis:
      - "*.example.com"
    cert: |
      -----BEGIN CERTIFICATE-----
      (certificate content)
      -----END CERTIFICATE-----
    key: |
      -----BEGIN PRIVATE KEY-----
      (private key content)
      -----END PRIVATE KEY-----
```

---

## é™„å½•

### å‚è€ƒé¡¹ç›®

- [Apache APISIX](https://github.com/apache/apisix) - è·¯ç”±å¼•æ“å‚è€ƒ
- [Kong](https://github.com/Kong/kong) - Hybrid æ¨¡å¼å‚è€ƒ
- [Envoy](https://github.com/envoyproxy/envoy) - èµ„æºæ¨¡å‹å‚è€ƒ

### ç›¸å…³ RFC

- RFC 8259: JSON æ•°æ®äº¤æ¢æ ¼å¼
- RFC 7540: HTTP/2
- RFC 8895: Server-Sent Events

---

*æ–‡æ¡£ç»“æŸ*
